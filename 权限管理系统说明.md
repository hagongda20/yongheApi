# ç”¨æˆ·æƒé™ç®¡ç†ç³»ç»Ÿè¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å·²å®ç°åŸºäºè§’è‰²çš„æƒé™ç®¡ç†ç³»ç»Ÿï¼ˆRBAC - Role-Based Access Controlï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹åŠŸèƒ½ï¼š

### 1. ç”¨æˆ·è§’è‰²
- **admin** - ç®¡ç†å‘˜ï¼šæ‹¥æœ‰æ‰€æœ‰æƒé™
- **user** - æ™®é€šç”¨æˆ·ï¼šåŸºç¡€æƒé™

### 2. æƒé™è£…é¥°å™¨
- `@login_required` - éœ€è¦ç™»å½•
- `@admin_required` - éœ€è¦ç®¡ç†å‘˜æƒé™
- `@role_required('admin', 'user')` - éœ€è¦æŒ‡å®šè§’è‰²ä¹‹ä¸€

### 3. ç”¨æˆ·ç®¡ç†æ¥å£ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/users/management/` | è·å–æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ |
| GET | `/api/users/management/<user_id>` | è·å–æŒ‡å®šç”¨æˆ·ä¿¡æ¯ |
| PUT | `/api/users/management/<user_id>/role` | ä¿®æ”¹ç”¨æˆ·è§’è‰² |
| DELETE | `/api/users/management/<user_id>` | åˆ é™¤ç”¨æˆ· |
| PUT | `/api/users/management/<user_id>/password` | ä¿®æ”¹ç”¨æˆ·å¯†ç  |
| GET | `/api/users/management/me` | è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ |

### 4. è®¤è¯æ¥å£

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| POST | `/api/users/register` | ç”¨æˆ·æ³¨å†Œï¼ˆé»˜è®¤è§’è‰²ä¸º userï¼‰ |
| POST | `/api/users/` | ç”¨æˆ·ç™»å½•ï¼ˆè¿”å› token å’Œè§’è‰²ä¿¡æ¯ï¼‰ |

---

## ğŸš€ ä½¿ç”¨æ­¥éª¤

### æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“è¿ç§»

```bash
cd yongheApi

# åˆ›å»ºè¿ç§»æ–‡ä»¶
flask db migrate -m "æ·»åŠ ç”¨æˆ·è§’è‰²å­—æ®µ"

# æ‰§è¡Œè¿ç§»
flask db upgrade
```

### æ­¥éª¤ 2: åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·

**æ–¹æ³• 1: ä½¿ç”¨è„šæœ¬ï¼ˆæ¨èï¼‰**

åˆ›å»ºä¸€ä¸ªä¸´æ—¶è„šæœ¬ `create_admin.py`:

```python
from app import app
from models import User
from db_config import db

with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('admin123')  # ä¿®æ”¹ä¸ºä½ æƒ³è¦çš„å¯†ç 
    db.session.add(admin)
    db.session.commit()
    print("ç®¡ç†å‘˜åˆ›å»ºæˆåŠŸï¼")
```

è¿è¡Œï¼š
```bash
python create_admin.py
```

**æ–¹æ³• 2: ä½¿ç”¨æ³¨å†Œæ¥å£ï¼ˆéœ€è¦å…ˆæ‰‹åŠ¨è®¾ç½®ï¼‰**

å…ˆæ³¨å†Œä¸€ä¸ªæ™®é€šç”¨æˆ·ï¼Œç„¶åé€šè¿‡æ•°æ®åº“ç›´æ¥ä¿®æ”¹è§’è‰²ä¸º `admin`ã€‚

### æ­¥éª¤ 3: æµ‹è¯•æ¥å£

#### 3.1 æ³¨å†Œç”¨æˆ·
```bash
POST http://localhost:6000/api/users/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "123456"
}
```

#### 3.2 ç™»å½•
```bash
POST http://localhost:6000/api/users/
Content-Type: application/json

{
  "username": "admin",
  "password": "admin123"
}
```

è¿”å›ï¼š
```json
{
  "code": 200,
  "token": "eyJ...",
  "username": "admin",
  "role": "admin",
  "user": {
    "id": 1,
    "username": "admin",
    "role": "admin",
    "last_login_time": "2025-01-XX XX:XX:XX"
  }
}
```

#### 3.3 è·å–ç”¨æˆ·åˆ—è¡¨ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
```bash
GET http://localhost:6000/api/users/management/
Authorization: <token>
```

#### 3.4 ä¿®æ”¹ç”¨æˆ·è§’è‰²ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰
```bash
PUT http://localhost:6000/api/users/management/2/role
Authorization: <token>
Content-Type: application/json

{
  "role": "admin"
}
```

#### 3.5 è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
```bash
GET http://localhost:6000/api/users/management/me
Authorization: <token>
```

---

## ğŸ”’ æƒé™æ§åˆ¶ç¤ºä¾‹

### ç¤ºä¾‹ 1: ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰

```python
from utils.decorators import admin_required

@worker_bp.route('/admin-only', methods=['GET'])
@admin_required
def admin_only_route(current_user):
    # current_user æ˜¯å½“å‰ç™»å½•çš„ç”¨æˆ·å¯¹è±¡
    return jsonify({'msg': 'åªæœ‰ç®¡ç†å‘˜èƒ½è®¿é—®'})
```

### ç¤ºä¾‹ 2: ä¿æŠ¤è·¯ç”±ï¼ˆéœ€è¦æŒ‡å®šè§’è‰²ï¼‰

```python
from utils.decorators import role_required

@worker_bp.route('/special', methods=['GET'])
@role_required('admin', 'manager')  # éœ€è¦ admin æˆ– manager è§’è‰²
def special_route(current_user):
    return jsonify({'msg': 'ç‰¹æ®Šæƒé™æ‰èƒ½è®¿é—®'})
```

### ç¤ºä¾‹ 3: åœ¨è·¯ç”±ä¸­æ£€æŸ¥æƒé™

```python
from utils.decorators import login_required, get_current_user

@worker_bp.route('/check', methods=['GET'])
@login_required
def check_route(current_user):
    if current_user.is_admin():
        # ç®¡ç†å‘˜é€»è¾‘
        return jsonify({'msg': 'ç®¡ç†å‘˜åŠŸèƒ½'})
    else:
        # æ™®é€šç”¨æˆ·é€»è¾‘
        return jsonify({'msg': 'æ™®é€šç”¨æˆ·åŠŸèƒ½'})
```

---

## ğŸ“Š æ•°æ®åº“ç»“æ„

### User è¡¨æ–°å¢å­—æ®µ

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| role | String(20) | ç”¨æˆ·è§’è‰² | 'user' |

### User æ¨¡å‹æ–°å¢æ–¹æ³•

- `is_admin()` - æ£€æŸ¥æ˜¯å¦ä¸ºç®¡ç†å‘˜
- `has_role(role)` - æ£€æŸ¥æ˜¯å¦å…·æœ‰æŒ‡å®šè§’è‰²
- `to_dict()` - è½¬æ¢ä¸ºå­—å…¸ï¼ˆä¸åŒ…å«æ•æ„Ÿä¿¡æ¯ï¼‰

---

## ğŸ›¡ï¸ å®‰å…¨è¯´æ˜

1. **å¯†ç å®‰å…¨**
   - å¯†ç ä½¿ç”¨ `pbkdf2:sha256` åŠ å¯†å­˜å‚¨
   - ä¸ä¼šåœ¨ API å“åº”ä¸­è¿”å›å¯†ç 

2. **Token éªŒè¯**
   - æ¯æ¬¡è¯·æ±‚éƒ½éœ€è¦åœ¨ Header ä¸­æºå¸¦ `Authorization: <token>`
   - Token æœ‰è¿‡æœŸæ—¶é—´ï¼ˆ12å°æ—¶ï¼‰
   - æ”¯æŒé¡¶å·åŠŸèƒ½ï¼ˆæ–°ç™»å½•ä¼šå¤±æ•ˆæ—§ tokenï¼‰

3. **æƒé™æ£€æŸ¥**
   - ç®¡ç†å‘˜ä¸èƒ½åˆ é™¤è‡ªå·±
   - ç®¡ç†å‘˜ä¸èƒ½ä¿®æ”¹è‡ªå·±çš„è§’è‰²
   - æ™®é€šç”¨æˆ·åªèƒ½ä¿®æ”¹è‡ªå·±çš„å¯†ç 

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯• 1: æ™®é€šç”¨æˆ·å°è¯•è®¿é—®ç®¡ç†å‘˜æ¥å£

```bash
# 1. æ³¨å†Œæ™®é€šç”¨æˆ·
POST /api/users/register
{"username": "user1", "password": "123456"}

# 2. ç™»å½•è·å– token
POST /api/users/
{"username": "user1", "password": "123456"}

# 3. å°è¯•è®¿é—®ç®¡ç†å‘˜æ¥å£ï¼ˆåº”è¯¥è¿”å› 403ï¼‰
GET /api/users/management/
Authorization: <user1_token>
# é¢„æœŸ: {"code": 403, "msg": "éœ€è¦ç®¡ç†å‘˜æƒé™"}
```

### æµ‹è¯• 2: ç®¡ç†å‘˜ç®¡ç†ç”¨æˆ·

```bash
# 1. ç®¡ç†å‘˜ç™»å½•
POST /api/users/
{"username": "admin", "password": "admin123"}

# 2. è·å–ç”¨æˆ·åˆ—è¡¨
GET /api/users/management/
Authorization: <admin_token>

# 3. ä¿®æ”¹ç”¨æˆ·è§’è‰²
PUT /api/users/management/2/role
Authorization: <admin_token>
{"role": "admin"}
```

---

## ğŸ”§ å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•ç»™ç°æœ‰ç”¨æˆ·æ·»åŠ è§’è‰²ï¼Ÿ

æ‰§è¡Œæ•°æ®åº“è¿ç§»åï¼Œç°æœ‰ç”¨æˆ·çš„ `role` å­—æ®µé»˜è®¤ä¸º `'user'`ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¿®æ”¹ï¼š

1. **ä½¿ç”¨ API**ï¼ˆéœ€è¦ç®¡ç†å‘˜ï¼‰:
   ```bash
   PUT /api/users/management/<user_id>/role
   {"role": "admin"}
   ```

2. **ç›´æ¥ä¿®æ”¹æ•°æ®åº“**:
   ```sql
   UPDATE users SET role = 'admin' WHERE username = 'admin';
   ```

### Q2: å¦‚ä½•é‡ç½®ç®¡ç†å‘˜å¯†ç ï¼Ÿ

```python
from app import app
from models import User
from db_config import db

with app.app_context():
    admin = User.query.filter_by(username='admin').first()
    if admin:
        admin.set_password('new_password')
        db.session.commit()
        print("å¯†ç é‡ç½®æˆåŠŸ")
```

### Q3: å¦‚ä½•æ·»åŠ æ–°çš„è§’è‰²ï¼Ÿ

1. ä¿®æ”¹ `models.py` ä¸­çš„è§’è‰²éªŒè¯é€»è¾‘
2. æ›´æ–° `routes/auth.py` ä¸­çš„æ³¨å†Œæ¥å£
3. æ›´æ–° `routes/user_management.py` ä¸­çš„è§’è‰²éªŒè¯

---

## ğŸ“ ä¸‹ä¸€æ­¥å»ºè®®

1. **å‰ç«¯é›†æˆ**
   - æ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤º/éšè—åŠŸèƒ½
   - æ·»åŠ ç”¨æˆ·ç®¡ç†é¡µé¢
   - æ·»åŠ è§’è‰²åˆ‡æ¢åŠŸèƒ½

2. **æ‰©å±•åŠŸèƒ½**
   - æ·»åŠ æ›´å¤šè§’è‰²ï¼ˆå¦‚ manager, viewerï¼‰
   - å®ç°ç»†ç²’åº¦æƒé™æ§åˆ¶ï¼ˆåŸºäºæƒé™è€Œéè§’è‰²ï¼‰
   - æ·»åŠ æ“ä½œæ—¥å¿—è®°å½•

3. **å®‰å…¨æ€§å¢å¼º**
   - æ·»åŠ å¯†ç å¼ºåº¦éªŒè¯
   - æ·»åŠ ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶
   - æ·»åŠ  IP ç™½åå•åŠŸèƒ½

---

## âœ… å®Œæˆæ¸…å•

- [x] åœ¨ User æ¨¡å‹ä¸­æ·»åŠ  role å­—æ®µ
- [x] åˆ›å»ºæƒé™è£…é¥°å™¨ï¼ˆadmin_required, role_requiredï¼‰
- [x] åˆ›å»ºç”¨æˆ·ç®¡ç†è·¯ç”±
- [x] æ›´æ–°æ³¨å†Œå’Œç™»å½•æ¥å£
- [x] åˆ›å»ºæ•°æ®åº“è¿ç§»ï¼ˆéœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼‰
- [ ] å‰ç«¯é›†æˆæƒé™ç®¡ç†
- [ ] æ·»åŠ æ“ä½œæ—¥å¿—

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿï¼

